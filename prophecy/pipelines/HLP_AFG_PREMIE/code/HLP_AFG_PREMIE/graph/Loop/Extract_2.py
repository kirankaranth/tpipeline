from pyspark.sql import *
from pyspark.sql.functions import *
from pyspark.sql.types import *
from prophecy.utils import *
from prophecy.libs import typed_lit
from .config import *
from HLP_AFG_PREMIE.udfs.UDFs import *

def Extract_2(spark: SparkSession, BL_RGL: DataFrame) -> (DataFrame):

    try:
        registerUDFs(spark)
    except NameError:
        print("registerUDFs not working")

    BL_RGL.createOrReplaceTempView("BL_RGL")
    df1 = spark.sql(
        "SELECT\n  *\n  EXCEPT (_CALC_BL_INGANG_DTM, _WHERE_EXPR),\n  _CALC_BL_INGANG_DTM AS BL_INGANG_DTM\nFROM (\n  SELECT\n    ZORGVERZEKERING_IDC,\n    BRN_PERSOON_ID,\n    GEBOORTE_DTM,\n    LAND_ID,\n    ZORGVERZ_OVEREENKOMST_ID,\n    BOUWSTEEN_ID,\n    LABEL_ID,\n    PRODUCTSET_SOORT_ID,\n    COLLECTIVITEIT_OVEREENKOMST_ID,\n    BETAAL_TERMIJN_ID,\n    EIGEN_RISICO_REGELING_ID,\n    REFERENTIEPREMIE_BDG,\n    FABRIEKSPRIJS_BDG,\n    COMMERCIELE_TOESLAG_BDG,\n    EDWH_RESOURCE_ID,\n    CASE\n      WHEN NOT LEEFTIJD_VAN_BL IS NULL\n      AND COALESCE(LEEFTIJD_VAN_BL, CAST('-inf' AS FLOAT)) > COALESCE(INGANG_DTM_LEEFTIJD, CAST('-inf' AS FLOAT))\n      THEN MAKE_DATE(\n        IF(\n          CASE\n            WHEN COALESCE(MONTH(GEBOORTE_DTM), CAST('-inf' AS FLOAT)) < 12\n            AND NOT (\n              LEEFTIJD_JAAR_INGANGSDATUM <=> 30\n            )\n            THEN YEAR(GEBOORTE_DTM)\n            ELSE YEAR(GEBOORTE_DTM) + 1\n          END + LEEFTIJD_VAN_BL < 100,\n          CAST((\n            IF(\n              CASE\n                WHEN COALESCE(MONTH(GEBOORTE_DTM), CAST('-inf' AS FLOAT)) < 12\n                AND NOT (\n                  LEEFTIJD_JAAR_INGANGSDATUM <=> 30\n                )\n                THEN YEAR(GEBOORTE_DTM)\n                ELSE YEAR(GEBOORTE_DTM) + 1\n              END + LEEFTIJD_VAN_BL < 40,\n              '20',\n              '19'\n            ) || CASE\n              WHEN COALESCE(MONTH(GEBOORTE_DTM), CAST('-inf' AS FLOAT)) < 12\n              AND NOT (\n                LEEFTIJD_JAAR_INGANGSDATUM <=> 30\n              )\n              THEN YEAR(GEBOORTE_DTM)\n              ELSE YEAR(GEBOORTE_DTM) + 1\n            END + LEEFTIJD_VAN_BL\n          ) AS INT),\n          CASE\n            WHEN COALESCE(MONTH(GEBOORTE_DTM), CAST('-inf' AS FLOAT)) < 12\n            AND NOT (\n              LEEFTIJD_JAAR_INGANGSDATUM <=> 30\n            )\n            THEN YEAR(GEBOORTE_DTM)\n            ELSE YEAR(GEBOORTE_DTM) + 1\n          END + LEEFTIJD_VAN_BL\n        ),\n        CASE\n          WHEN COALESCE(MONTH(GEBOORTE_DTM), CAST('-inf' AS FLOAT)) < 12\n          AND NOT (\n            LEEFTIJD_JAAR_INGANGSDATUM <=> 30\n          )\n          THEN MONTH(GEBOORTE_DTM) + 1\n          ELSE 1\n        END,\n        1\n      )\n      ELSE INGANG_DTM\n    END AS _CALC_BL_INGANG_DTM,\n    CASE\n      WHEN NOT LEEFTIJD_TOT_MET_BL IS NULL\n      AND COALESCE(LEEFTIJD_TOT_MET_BL, CAST('-inf' AS FLOAT)) < COALESCE(EIND_DTM_LEEFTIJD, CAST('-inf' AS FLOAT))\n      THEN MAKE_DATE(\n        IF(\n          CASE\n            WHEN COALESCE(MONTH(GEBOORTE_DTM), CAST('-inf' AS FLOAT)) < 12\n            AND NOT (\n              LEEFTIJD_JAAR_INGANGSDATUM <=> 30\n            )\n            THEN YEAR(GEBOORTE_DTM)\n            ELSE YEAR(GEBOORTE_DTM) + 1\n          END + LEEFTIJD_TOT_MET_BL + 1 < 100,\n          CAST((\n            IF(\n              CASE\n                WHEN COALESCE(MONTH(GEBOORTE_DTM), CAST('-inf' AS FLOAT)) < 12\n                AND NOT (\n                  LEEFTIJD_JAAR_INGANGSDATUM <=> 30\n                )\n                THEN YEAR(GEBOORTE_DTM)\n                ELSE YEAR(GEBOORTE_DTM) + 1\n              END + LEEFTIJD_TOT_MET_BL + 1 < 40,\n              '20',\n              '19'\n            ) || CASE\n              WHEN COALESCE(MONTH(GEBOORTE_DTM), CAST('-inf' AS FLOAT)) < 12\n              AND NOT (\n                LEEFTIJD_JAAR_INGANGSDATUM <=> 30\n              )\n              THEN YEAR(GEBOORTE_DTM)\n              ELSE YEAR(GEBOORTE_DTM) + 1\n            END + LEEFTIJD_TOT_MET_BL + 1\n          ) AS INT),\n          CASE\n            WHEN COALESCE(MONTH(GEBOORTE_DTM), CAST('-inf' AS FLOAT)) < 12\n            AND NOT (\n              LEEFTIJD_JAAR_INGANGSDATUM <=> 30\n            )\n            THEN YEAR(GEBOORTE_DTM)\n            ELSE YEAR(GEBOORTE_DTM) + 1\n          END + LEEFTIJD_TOT_MET_BL + 1\n        ),\n        CASE\n          WHEN COALESCE(MONTH(GEBOORTE_DTM), CAST('-inf' AS FLOAT)) < 12\n          AND NOT (\n            LEEFTIJD_JAAR_INGANGSDATUM <=> 30\n          )\n          THEN MONTH(GEBOORTE_DTM) + 1\n          ELSE 1\n        END,\n        1\n      ) - 1\n      ELSE EIND_DTM\n    END AS BL_EIND_DTM,\n    LEEFTIJD_VAN,\n    LEEFTIJD_TOT_MET,\n    LEEFTIJD_BDG,\n    LFT_FABRIEKSPRIJS_BDG,\n    LFT_COMM_TOESLAG_BDG,\n    PREMIE_AFWIJKEND_BDG,\n    LEEFTIJD_PCT,\n    PREMIE_AFWIJKEND_PCT,\n    COLLECTIVITEIT_BDG,\n    COLLECTIVITEIT_PCT,\n    PAKKET_KORTING_PCT,\n    LEEFTIJD_VAN_ER,\n    LEEFTIJD_TOT_MET_ER,\n    EIGEN_RISICO_BDG,\n    ER_FABRIEKSPRIJS_BDG,\n    ER_COMM_TOESLAG_BDG,\n    EIGEN_RISICO_PCT,\n    ASSURANTIE_PCT,\n    LEEFTIJD_VAN_BL,\n    LEEFTIJD_TOT_MET_BL,\n    BUITENLAND_BDG,\n    BUITENLAND_PCT,\n    INGANG_DTM_LEEFTIJD,\n    EIND_DTM_LEEFTIJD,\n    DETENTIE_IDC,\n    GESLACHT_ID,\n    (\n      LEEFTIJD_VAN_BL IS NULL\n      OR COALESCE(INGANG_DTM_LEEFTIJD, CAST('-inf' AS FLOAT)) <= COALESCE(LEEFTIJD_TOT_MET_BL, CAST('-inf' AS FLOAT))\n      AND COALESCE(EIND_DTM_LEEFTIJD, CAST('-inf' AS FLOAT)) >= COALESCE(LEEFTIJD_VAN_BL, CAST('-inf' AS FLOAT))\n      AND COALESCE(_CALC_BL_INGANG_DTM, CAST('0001-01-01' AS DATE)) <= COALESCE(EIND_DTM, CAST('0001-01-01' AS DATE))\n    ) AS _WHERE_EXPR\n  FROM BL_RGL\n)\nWHERE\n  _WHERE_EXPR"
    )

    return df1
